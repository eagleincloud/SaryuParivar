<!-- Support/Help Widget - Floating Button and Modal -->
<style>
  /* Support Widget Styles */
  .support-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
  }
  
  .support-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f97718 0%, #ff8c42 100%);
    color: white;
    border: none;
    box-shadow: 0 4px 20px rgba(249, 119, 24, 0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    transition: all 0.3s ease;
    position: relative;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  
  .support-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(249, 119, 24, 0.6);
  }
  
  .support-button:active {
    transform: scale(0.95);
  }
  
  .support-button::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 1;
    }
    100% {
      transform: scale(1.5);
      opacity: 0;
    }
  }
  
  .support-label {
    position: absolute;
    right: 70px;
    top: 50%;
    transform: translateY(-50%);
    background: white;
    padding: 8px 16px;
    border-radius: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    font-size: 14px;
    font-weight: 600;
    color: #f97718;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  
  .support-button:hover .support-label {
    opacity: 1;
  }
  
  /* Mobile Support Widget - Enhanced */
  @media (max-width: 768px) {
    .support-widget {
      bottom: 90px;
      right: 15px;
      left: auto;
    }
    
    .support-button {
      width: 56px;
      height: 56px;
      font-size: 24px;
      box-shadow: 0 4px 15px rgba(249, 119, 24, 0.5);
    }
    
    .support-button:active {
      transform: scale(0.9);
    }
    
    .support-label {
      display: none;
    }
    
    /* Mobile Modal Optimization */
    #supportModal .modal-dialog {
      margin: 10px;
      max-width: calc(100% - 20px);
    }
    
    #supportModal .modal-content {
      border-radius: 16px !important;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    #supportModal .modal-header {
      padding: 16px 20px !important;
      border-radius: 16px 16px 0 0 !important;
    }
    
    #supportModal .modal-title {
      font-size: 20px !important;
    }
    
    #supportModal .modal-body {
      padding: 20px 16px !important;
    }
    
    #supportModal .form-control,
    #supportModal input,
    #supportModal textarea {
      font-size: 16px !important;
      padding: 14px 16px !important;
      border-radius: 12px !important;
      -webkit-appearance: none;
      appearance: none;
    }
    
    #supportModal .form-label {
      font-size: 14px !important;
      margin-bottom: 8px !important;
    }
    
    #supportModal button[type="submit"] {
      padding: 16px !important;
      font-size: 16px !important;
      width: 100% !important;
      border-radius: 12px !important;
    }
    
    #supportModal textarea {
      min-height: 120px !important;
      resize: vertical;
    }
  }
  
  /* Very Small Mobile Devices */
  @media (max-width: 480px) {
    .support-widget {
      bottom: 80px;
      right: 12px;
    }
    
    .support-button {
      width: 52px;
      height: 52px;
      font-size: 22px;
    }
    
    #supportModal .modal-dialog {
      margin: 8px;
      max-width: calc(100% - 16px);
    }
    
    #supportModal .modal-body {
      padding: 16px 12px !important;
    }
  }
  
  /* Prevent body scroll when modal is open on mobile */
  body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
  }
</style>

<!-- Support Button -->
<div class="support-widget">
  <button type="button" class="support-button" data-bs-toggle="modal" data-bs-target="#supportModal" title="Need Help? Contact Support">
    <i class="bx bx-support"></i>
    <span class="support-label">Need Help?</span>
  </button>
</div>

<!-- Support Modal -->
<div class="modal fade" id="supportModal" tabindex="-1" aria-labelledby="supportModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
      <div class="modal-header" style="background: linear-gradient(135deg, #f97718 0%, #ff8c42 100%); border-radius: 20px 20px 0 0; border: none; padding: 20px 30px;">
        <h5 class="modal-title text-white montserrat" id="supportModalLabel" style="font-size: 24px; font-weight: 700;">
          <i class="bx bx-support"></i> Contact Support
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <p class="poppins mb-4" style="color: #666; font-size: 15px; line-height: 1.6;">
          Have a question or need help? Fill out the form below and we'll get back to you as soon as possible.
        </p>
        
        <div id="support-message" class="alert" style="display: none; border-radius: 10px; margin-bottom: 20px; padding: 12px 16px; font-size: 14px;"></div>
        
        <form id="supportForm" method="POST" action="{% url 'submit_support' %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="support_name" class="form-label poppins" style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">
              Name <span style="color: #f97718;">*</span>
            </label>
            <input type="text" class="form-control poppins" id="support_name" name="name" placeholder="Enter your name" required style="border-radius: 12px; border: 1.5px solid #d1d5db; padding: 12px 16px; width: 100%; font-size: 16px; -webkit-appearance: none; appearance: none;">
          </div>
          
          <div class="mb-3">
            <label for="support_email" class="form-label poppins" style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">
              Email <span style="color: #f97718;">*</span>
            </label>
            <input type="email" class="form-control poppins" id="support_email" name="email" placeholder="Enter your email" required style="border-radius: 12px; border: 1.5px solid #d1d5db; padding: 12px 16px; width: 100%; font-size: 16px; -webkit-appearance: none; appearance: none;">
          </div>
          
          <div class="mb-3">
            <label for="support_phone" class="form-label poppins" style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">
              Phone Number <span style="color: #999; font-size: 12px; font-weight: 400;">(Optional)</span>
            </label>
            <input type="tel" class="form-control poppins" id="support_phone" name="phone_number" placeholder="Enter your phone number" style="border-radius: 12px; border: 1.5px solid #d1d5db; padding: 12px 16px; width: 100%; font-size: 16px; -webkit-appearance: none; appearance: none;">
          </div>
          
          <div class="mb-3">
            <label for="support_subject" class="form-label poppins" style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">
              Subject <span style="color: #f97718;">*</span>
            </label>
            <input type="text" class="form-control poppins" id="support_subject" name="subject" placeholder="What can we help you with?" required style="border-radius: 12px; border: 1.5px solid #d1d5db; padding: 12px 16px; width: 100%; font-size: 16px; -webkit-appearance: none; appearance: none;">
          </div>
          
          <div class="mb-4">
            <label for="support_message" class="form-label poppins" style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">
              Message <span style="color: #f97718;">*</span>
            </label>
            <textarea class="form-control poppins" id="support_message" name="message" rows="5" placeholder="Describe your issue or question in detail..." required style="border-radius: 12px; border: 1.5px solid #d1d5db; padding: 12px 16px; resize: vertical; width: 100%; font-size: 16px; min-height: 120px; -webkit-appearance: none; appearance: none; font-family: inherit;"></textarea>
          </div>
          
          <button type="submit" class="btn w-100 poppins fw-semibold text-white" style="background: linear-gradient(135deg, #f97718 0%, #ff8c42 100%); border: none; border-radius: 12px; padding: 14px; font-size: 16px; transition: all 0.3s; touch-action: manipulation;">
            <i class="bx bx-send"></i> Send Message
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Auto-fill form if user is logged in
  {% if user.is_authenticated %}
    document.addEventListener('DOMContentLoaded', function() {
      const nameField = document.getElementById('support_name');
      const emailField = document.getElementById('support_email');
      const phoneField = document.getElementById('support_phone');
      
      if (nameField && !nameField.value) {
        nameField.value = '{{ user.get_full_name|default:user.show_username }}';
      }
      if (emailField && !emailField.value) {
        emailField.value = '{{ user.email|default:"" }}';
      }
      if (phoneField && !phoneField.value) {
        phoneField.value = '{{ user.phone_number|default:"" }}';
      }
    });
  {% endif %}
  
  // Handle form submission
  document.addEventListener('DOMContentLoaded', function() {
    const supportForm = document.getElementById('supportForm');
    const supportMessage = document.getElementById('support-message');
    const supportModal = document.getElementById('supportModal');
    
    // Prevent body scroll on mobile when modal is open
    if (supportModal) {
      supportModal.addEventListener('show.bs.modal', function() {
        document.body.classList.add('modal-open');
      });
      
      supportModal.addEventListener('hidden.bs.modal', function() {
        document.body.classList.remove('modal-open');
      });
    }
    
    if (supportForm) {
      supportForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(supportForm);
        const submitButton = supportForm.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        
        // Show loading state
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Sending...';
        supportMessage.style.display = 'none';
        
        // Scroll to top of modal on mobile
        if (window.innerWidth <= 768) {
          const modalBody = supportModal.querySelector('.modal-body');
          if (modalBody) {
            modalBody.scrollTop = 0;
          }
        }
        
        try {
          const response = await fetch('{% url "submit_support" %}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });
          
          const data = await response.json();
          
          if (data.success) {
            supportMessage.className = 'alert alert-success';
            supportMessage.textContent = data.message || 'Thank you for contacting us! We will get back to you soon.';
            supportMessage.style.display = 'block';
            supportForm.reset();
            
            // Re-fill form if user is logged in
            {% if user.is_authenticated %}
            const nameField = document.getElementById('support_name');
            const emailField = document.getElementById('support_email');
            const phoneField = document.getElementById('support_phone');
            if (nameField) nameField.value = '{{ user.get_full_name|default:user.show_username }}';
            if (emailField) emailField.value = '{{ user.email|default:"" }}';
            if (phoneField) phoneField.value = '{{ user.phone_number|default:"" }}';
            {% endif %}
            
            // Scroll to message on mobile
            if (window.innerWidth <= 768) {
              supportMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // Auto-close modal after 3 seconds
            setTimeout(function() {
              const modal = bootstrap.Modal.getInstance(supportModal);
              if (modal) {
                modal.hide();
              }
            }, 3000);
          } else {
            supportMessage.className = 'alert alert-danger';
            supportMessage.textContent = data.message || 'An error occurred. Please try again.';
            supportMessage.style.display = 'block';
            
            // Scroll to message on mobile
            if (window.innerWidth <= 768) {
              supportMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
          }
        } catch (error) {
          console.error('Error submitting support request:', error);
          supportMessage.className = 'alert alert-danger';
          supportMessage.textContent = 'Network error. Please check your connection and try again.';
          supportMessage.style.display = 'block';
          
          // Scroll to message on mobile
          if (window.innerWidth <= 768) {
            supportMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        } finally {
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonText;
        }
      });
    }
  });
</script>

