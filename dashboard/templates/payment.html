<!doctype html>
{% load static %}
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="{% static 'images/saryu-parivaar-logo.png' %}">
  <title>Saryu Parivar - Candidate Form</title>
  <link rel="stylesheet" href="https://unpkg.com/simplebar@latest/dist/simplebar.css"/>
  <link href='https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/metisMenu/3.0.7/metisMenu.min.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
</head>
<body class=" bg-[#ffecce]">

  <!-- dashboard -->
  <section class="wrapper">
    <div class="sidebar_wrapper" data-simplebar>
      <div class="simplebar-wrapper">
        <div class="simplebar-height-auto-observer-wrapper">
          <div class="simplebar-height-auto-observer"></div>
        </div>
        <div class="simplebar-mask">
          <div class="simplebar-offset">
            <div class="simplebar-content-wrapper">
              <div class="simplebar-content mm-active">
                <div class="sidebar-header">
                  <div>
                    <img src="{% static 'images/saryu-parivaar-logo.png' %}" class="logo w-36">
                  </div>
                  <div class="toggle-icon m-auto">
                    <i class="bx bx-arrow-to-left" id="btn"></i>
                  </div>
                </div>
                <ul class="metisMenu mm-show" id="menu">
                  <!-- <li class="mm-active">
                    <a href="{% url 'all_profiles' %}">
                      <div class="parent-icon">
                        <i class="bx bxs-dashboard"></i>
                      </div>
                      <div class="menu-title">
                        <span>Dashboard</span>
                      </div>
                    </a>
                  </li> -->
                  <li>
                    <a class="has-arrow">
                      <div class="parent-icon">
                        <i class="bx bx-user"></i>
                      </div>
                      <div class="menu-title">
                        <span>Matrimonial</span>
                      </div>
                    </a>
                    <ul class="mm-collapse">
                      <li>
                        <a href="{% url 'all_profiles' %}">
                          <i class='bx bx-right-arrow-alt'></i>
                          All Profiles
                        </a>
                      </li>
                      <li>
                        <a href="{% url 'profile' %}">
                          <i class='bx bx-right-arrow-alt'></i>
                          My Profile
                        </a>
                      </li>
                      <li>
                        <a href="{% url 'payment' %}">
                          <i class='bx bx-right-arrow-alt'></i>
                          Payment
                        </a>
                      </li>
                    </ul>
                  </li>
                </ul>
              </div>              
            </div>
          </div>
        </div>
        <div class="simplebar-placeholder"></div>
      </div>
      <div class="simplebar-track simplebar-horizontal" style="visibility: hidden;">
        <div class="simplebar-scrollbar" style="width: 0px; display: none;"></div>
      </div>
      <div class="simplebar-track simplebar-vertical" style="visibility: visible;">
        <div class="simplebar-scrollbar" style="height: 83px; transform: translate3d(0px, 0px, 0px); display: block;"></div>
      </div>
    </div>
    <header>
      <div class="topbar d-flex align-items-center">
        <nav class="navbar navbar-expand">
          <div class="search-bar flex-grow-1">
            <!-- <div class="position-relative search-bar-box">
              <input type="text" class="form-control search-control" placeholder="Type to search...">
              <span class="position-absolute top-50 search-show translate-middle-y">
                <i class="bx bx-search"></i>
              </span>
              <span class="position-absolute top-50 search-close translate-middle-y">
                <i class="bx bx-x"></i>
              </span>
            </div> -->
          </div>
          <!-- Payment Verification Badge -->
          {% if payment_pending or not payment_done %}
          <div class="payment-badge-container me-3">
            <a href="/payment/" class="payment-verification-badge" title="{% if payment_pending %}Payment verification pending{% else %}Payment required{% endif %}" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border-radius: 20px; text-decoration: none; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3); transition: all 0.3s ease;">
              <i class="bx bx-time-five" style="font-size: 14px;"></i>
              <span class="d-none d-md-inline">{% if payment_pending %}Verification Pending{% else %}Payment Required{% endif %}</span>
              <span class="d-md-none">Pending</span>
            </a>
          </div>
          {% endif %}
          <div class="user-box dropdown">
            <a class="d-flex align-items-center nav-link dropdown-toggle dropdown-toggle-nocaret" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="{{user_avatar}}" class="user-img" alt="user avatar">
              <div class="user-info ps-3">
                <p class="user-name mb-0">{{username}}</p>
                <!-- <p class="designattion mb-0">Web Designer</p> -->
              </div>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a href="{% url 'logout_user' %}" class="dropdown-item"><i class='bx bx-log-out-circle'></i> Logout</a>
              </li>
            </ul>
          </div>
        </nav>
      </div>
    </header>
    <!-- <div class="page_wrapper">
      <div class="page-content">
        <div class="register-form-form bg-white p-10">
            <h2 class="text-4xl font-medium montserrat text-center mb-5">Edit Profile</h2>
            <div class="block sm:flex">
                <div class="mx-3 mb-3 w-full">
                  <img src="{% static 'images/qr_code.jpeg' %}" alt="Candidate Profile" width="200px">
                </div>
            </div>
        </div>
      </div>
    </div> -->
    
    <div class="page_wrapper">
        <div class="page-content">
            <!-- Success Message After Registration -->
            {% if messages %}
                {% for message in messages %}
                    {% if 'Account created successfully' in message.message or 'success' in message.tags %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert" style="margin: 15px; border-radius: 12px; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2); animation: slideDown 0.5s ease-out;">
                        <div class="d-flex align-items-center">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                                <i class="bx bx-check" style="font-size: 28px; color: white;"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="alert-heading mb-1 montserrat" style="color: #155724; font-weight: 700; font-size: 18px;">
                                    <i class="bx bx-party"></i> Registration Successful!
                                </h5>
                                <p class="mb-0 poppins" style="color: #155724; font-size: 14px; line-height: 1.5;">
                                    {{ message.message }}
                                </p>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="opacity: 0.7;"></button>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            <style>
              .payment-verification-badge:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
              }
              /* Mobile Responsive */
              @media (max-width: 768px) {
                .payment-badge-container {
                  margin-right: 8px !important;
                }
                .payment-verification-badge {
                  padding: 5px 10px !important;
                  font-size: 11px !important;
                }
                .user-box {
                  margin-left: auto;
                }
                .user-info {
                  display: none;
                }
                .topbar {
                  padding: 10px 15px !important;
                }
                .user-img {
                  width: 35px !important;
                  height: 35px !important;
                }
              }
            </style>
            
            
            <div class="register-form-form bg-white p-10 modern-card" style="border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); margin: 20px;">
                {% if payment_done and payment_transaction and payment_transaction.payment_status == 'completed' %}
                <!-- Payment Success Message -->
                <div class="text-center mb-5">
                    <div class="alert alert-success poppins" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">
                        <i class="bx bx-check-circle" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                        <h3 class="text-3xl font-bold mb-3" style="color: white;">Payment Successful!</h3>
                        <p class="mb-2" style="font-size: 18px; color: white;">Your payment has been verified and approved.</p>
                        <div class="mt-4 p-3" style="background: rgba(255,255,255,0.2); border-radius: 10px; display: inline-block;">
                            <p class="mb-1" style="font-size: 16px; font-weight: 600;">
                                <i class="bx bx-calendar-check"></i> Annual Subscription Activated
                            </p>
                            {% if payment_transaction.subscription_start_date and payment_transaction.subscription_end_date %}
                            <p class="mb-0" style="font-size: 14px;">
                                Valid until: <strong>{{ payment_transaction.subscription_end_date|date:"F d, Y" }}</strong>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <h2 class="text-4xl font-medium montserrat text-center mb-5 gradient-text">Complete Payment</h2>
                <p class="text-center poppins mb-5" style="color: #666; font-size: 16px;">
                  Scan the QR code below to make payment via UPI
                </p>
                {% endif %}
                
                {% if not payment_done or not payment_transaction or payment_transaction.payment_status != 'completed' %}
                <div class="text-center mb-4">
                    <div class="d-inline-block p-4" style="background: linear-gradient(135deg, #fff8e1 0%, #ffe082 100%); border-radius: 20px; box-shadow: 0 8px 24px rgba(249, 119, 24, 0.2);">
                        <img 
                        src="{% static 'images/qr_code.jpeg' %}" 
                        alt="Payment QR Code"
                        class="img-fluid"
                        style="max-width: 350px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    </div>
                </div>
                
                <div class="text-center mb-4">
                    <div class="alert alert-info poppins" style="background: #ffecce; border: 2px solid #f97718; color: #f97718; border-radius: 12px; padding: 15px; display: inline-block;">
                        <strong style="font-size: 18px;">Registration Fee:</strong>
                        <span style="font-size: 24px; font-weight: 700; margin-left: 10px;">â‚¹{% if payment_amount %}{{ payment_amount|floatformat:2 }}{% else %}500.00{% endif %}</span>
                    </div>
                </div>
                
                <div class="text-center mb-4">
                    <p class="poppins mb-2" style="color: #333; font-size: 16px; font-weight: 600;">
                        <i class="bx bx-credit-card"></i> UPI ID:
                    </p>
                    <p class="poppins mb-0" style="color: #f97718; font-size: 20px; font-weight: 700; background: #ffecce; padding: 10px 20px; border-radius: 10px; display: inline-block;">
                        adityagtiwari92-1@okicici
                    </p>
                </div>
                {% endif %}
                
                {% if payment_transaction %}
                <form id="payment_verification_form" method="POST" action="/verify_payment/" enctype="multipart/form-data" class="mt-5">
                    {% csrf_token %}
                    <input type="hidden" name="transaction_id" id="payment_transaction_id" value="{{ payment_transaction.transaction_id }}">
                    
                    <div class="mb-4">
                        <label for="payment_proof" class="poppins mb-2 d-block" style="color: #333; font-weight: 600; font-size: 16px;">
                            <i class="bx bx-upload"></i> Upload Payment Proof (Optional)
                        </label>
                        <input type="file" name="payment_proof" id="payment_proof" accept="image/*" class="form-control poppins" style="border: 2px dashed #f97718; border-radius: 12px; padding: 15px; background: #fff8e1;">
                        <small class="text-muted poppins mt-2 d-block">You can upload a screenshot or photo of your payment confirmation (optional). You can also upload it later from your dashboard.</small>
                    </div>
                    
                    <div id="payment_status_message" class="alert" style="display: none; border-radius: 10px;"></div>
                    
                    <div class="text-center d-grid gap-2">
                        {% if payment_done and payment_transaction and payment_transaction.payment_status == 'completed' %}
                        <button type="button" id="continue_btn" onclick="continueToPortal()" class="btn btn-lg poppins fw-semibold text-white" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border: none; border-radius: 12px; padding: 15px 40px; font-size: 18px; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); transition: all 0.3s;">
                            <i class="bx bx-right-arrow-circle"></i> Go to Dashboard
                        </button>
                        {% else %}
                        <button type="button" id="continue_btn" onclick="continueToPortal()" class="btn btn-lg poppins fw-semibold text-white" style="background: linear-gradient(135deg, #f97718 0%, #ff8c42 100%); border: none; border-radius: 12px; padding: 15px 40px; font-size: 18px; box-shadow: 0 4px 15px rgba(249, 119, 24, 0.3); transition: all 0.3s;">
                            <i class="bx bx-right-arrow-circle"></i> Continue to Portal
                        </button>
                        <button type="button" id="submit_payment_btn" onclick="submitPaymentProof()" class="btn btn-outline-secondary poppins" style="border-radius: 12px; padding: 12px 30px; font-size: 16px;">
                            <i class="bx bx-upload"></i> Upload Payment Proof (Optional)
                        </button>
                        {% endif %}
                    </div>
                </form>
                {% endif %}
                
                {% if not payment_done or not payment_transaction or payment_transaction.payment_status != 'completed' %}
                <div class="mt-4 text-center">
                    <p class="poppins" style="color: #666; font-size: 14px;">
                        <i class="bx bx-info-circle"></i> After uploading payment proof, admin will verify your payment and grant you full access.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <script>
    // Continue to Portal function
    window.continueToPortal = function() {
      // Redirect to dashboard/portal
      window.location.href = '/dashboard/';
    };
    
    // Payment proof submission (optional)
    window.submitPaymentProof = async function() {
      const form = document.getElementById('payment_verification_form');
      const formData = new FormData(form);
      const statusDiv = document.getElementById('payment_status_message');
      const submitBtn = document.getElementById('submit_payment_btn');
      
      // Check if file is selected (optional)
      const fileInput = document.getElementById('payment_proof');
      if (!fileInput.files || fileInput.files.length === 0) {
        statusDiv.className = 'alert alert-warning';
        statusDiv.textContent = 'Please select a payment proof file to upload.';
        statusDiv.style.display = 'block';
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-loading');
      statusDiv.style.display = 'none';

      try {
        const baseUrl = `${window.location.protocol}//${window.location.hostname}${window.location.port ? `:${window.location.port}` : ''}`;
        const response = await fetch(`${baseUrl}/verify_payment/`, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });

        const data = await response.json();
        
        if (data.success) {
          statusDiv.className = 'alert alert-success';
          statusDiv.textContent = data.message || 'Payment proof uploaded successfully!';
          statusDiv.style.display = 'block';
          
          // Reload after 2 seconds
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          statusDiv.className = 'alert alert-danger';
          statusDiv.textContent = data.message || 'Failed to submit payment proof';
          statusDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Error submitting payment:', error);
        statusDiv.className = 'alert alert-danger';
        statusDiv.textContent = 'An error occurred. Please try again.';
        statusDiv.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-loading');
        submitBtn.innerHTML = '<i class="bx bx-upload"></i> Upload Payment Proof (Optional)';
      }
    };
    </script>

    <footer class="bg-black py-2 text-white poppins">
      <p class="text-center">Copyright &copy; 2024 Saryu Parivar. All Rights Reserved.</p>
      <p class="text-center mb-0">Proudly designed and developed by Eagle in Cloud</p>
    </footer>
  </section>
  <!-- end of dashboard -->
 
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
  <script src="https://unpkg.com/simplebar@latest/dist/simplebar.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/metisMenu/3.0.7/metisMenu.min.js"></script>
  <script src="https://unpkg.com/boxicons@2.1.2/dist/boxicons.js"></script>
  <script src="{% static 'js/script.js' %}"></script>
</body>
</html>